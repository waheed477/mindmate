import "dotenv/config";
import express from "express";
import { createServer } from "http";
import { registerRoutes } from "./routes";
import { serveStatic } from "./static";
import { connectDB } from "./db";
import { setupAuth } from "./auth";

const app = express();
const httpServer = createServer(app);

// Middleware
app.use(express.json());
app.use(express.urlencoded({ extended: false }));

// CORS for frontend
app.use((req, res, next) => {
  res.header("Access-Control-Allow-Origin", "http://localhost:5173");
  res.header("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS");
  res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept, Authorization");
  res.header("Access-Control-Allow-Credentials", "true");
  
  if (req.method === "OPTIONS") {
    return res.sendStatus(200);
  }
  
  next();
});

(async () => {
  try {
    // Connect to MongoDB
    await connectDB();
    
    // Setup authentication routes
    setupAuth(app);
    
    // Register other routes
    await registerRoutes(httpServer, app);
    
    // Serve static files in production
    if (process.env.NODE_ENV === "production") {
      serveStatic(app);
    }
    
    // Start server
    const port = Number(process.env.PORT || 3000);
    httpServer.listen(port, "0.0.0.0", () => {
      console.log(`?? Server running on port ${port}`);
      console.log("\n?? Auth Endpoints:");
      console.log("   POST   /api/auth/register      - Register user");
      console.log("   POST   /api/auth/login         - Login user");
      console.log("   GET    /api/auth/me            - Get current user");
      console.log("   POST   /api/auth/logout        - Logout");
      console.log("\n?? Application Endpoints:");
      console.log("   GET    /api/doctors            - Get all doctors");
      console.log("   GET    /api/doctors/:id        - Get doctor by ID");
      console.log("   GET    /api/appointments       - Get appointments");
    });
    
  } catch (error) {
    console.error("? Failed to start server:", error);
    process.exit(1);
  }
})();
